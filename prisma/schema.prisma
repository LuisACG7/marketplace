generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model acceso_log {
  acceso_log_id BigInt   @id @default(autoincrement())
  usuario_id    BigInt?
  ip            String?  @db.Inet
  user_agent    String?
  exito         Boolean
  creado_en     DateTime @default(now()) @db.Timestamptz(6)
  usuario       usuario? @relation(fields: [usuario_id], references: [usuario_id], onUpdate: NoAction)

  @@index([ip], map: "idx_acceso_log_ip")
  @@index([usuario_id], map: "idx_acceso_log_usuario")
}

model categoria {
  categoria_id   BigInt        @id @default(autoincrement())
  nombre         String        @unique @db.VarChar(80)
  activa         Boolean       @default(true)
  creado_en      DateTime      @default(now()) @db.Timestamptz(6)
  actualizado_en DateTime      @default(now()) @db.Timestamptz(6)
  publicacion    publicacion[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model conversacion {
  conversacion_id                            BigInt    @id @default(autoincrement())
  usuario_a_id                               BigInt
  usuario_b_id                               BigInt
  creado_en                                  DateTime  @default(now()) @db.Timestamptz(6)
  usuario_conversacion_usuario_a_idTousuario usuario   @relation("conversacion_usuario_a_idTousuario", fields: [usuario_a_id], references: [usuario_id], onDelete: Cascade, onUpdate: NoAction)
  usuario_conversacion_usuario_b_idTousuario usuario   @relation("conversacion_usuario_b_idTousuario", fields: [usuario_b_id], references: [usuario_id], onDelete: Cascade, onUpdate: NoAction)
  mensaje                                    mensaje[]
}

model imagen_publicacion {
  imagen_id      BigInt      @id @default(autoincrement())
  publicacion_id BigInt
  url            String
  orden          Int         @default(0)
  creado_en      DateTime    @default(now()) @db.Timestamptz(6)
  actualizado_en DateTime    @default(now()) @db.Timestamptz(6)
  publicacion    publicacion @relation(fields: [publicacion_id], references: [publicacion_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([publicacion_id], map: "idx_imagen_publicacion_pub")
}

model mensaje {
  mensaje_id      BigInt       @id @default(autoincrement())
  conversacion_id BigInt
  emisor_id       BigInt
  contenido       String
  leido           Boolean      @default(false)
  creado_en       DateTime     @default(now()) @db.Timestamptz(6)
  conversacion    conversacion @relation(fields: [conversacion_id], references: [conversacion_id], onDelete: Cascade, onUpdate: NoAction)
  usuario         usuario      @relation(fields: [emisor_id], references: [usuario_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([conversacion_id], map: "idx_mensaje_conversacion")
  @@index([emisor_id], map: "idx_mensaje_emisor")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model publicacion {
  publicacion_id        BigInt                  @id @default(autoincrement())
  usuario_id            BigInt
  categoria_id          BigInt?
  titulo                String                  @db.VarChar(140)
  descripcion           String
  precio                Decimal                 @db.Decimal(12, 2)
  estado_item           estado_item             @default(usado)
  activo                Boolean                 @default(true)
  creado_en             DateTime                @default(now()) @db.Timestamptz(6)
  actualizado_en        DateTime                @default(now()) @db.Timestamptz(6)
  imagen_publicacion    imagen_publicacion[]
  categoria             categoria?              @relation(fields: [categoria_id], references: [categoria_id], onDelete: NoAction, onUpdate: NoAction)
  usuario               usuario                 @relation(fields: [usuario_id], references: [usuario_id], onDelete: Cascade, onUpdate: NoAction)
  publicacion_historial publicacion_historial[]
  reporte               reporte[]
  transaccion           transaccion[]

  @@index([categoria_id], map: "idx_publicacion_categoria")
  @@index([precio], map: "idx_publicacion_precio")
  @@index([usuario_id], map: "idx_publicacion_usuario")
}

model publicacion_historial {
  hist_id        BigInt      @id @default(autoincrement())
  publicacion_id BigInt
  usuario_id     BigInt?
  campo          String
  valor_anterior String?
  valor_nuevo    String?
  creado_en      DateTime    @default(now()) @db.Timestamptz(6)
  publicacion    publicacion @relation(fields: [publicacion_id], references: [publicacion_id], onDelete: Cascade, onUpdate: NoAction)
  usuario        usuario?    @relation(fields: [usuario_id], references: [usuario_id], onUpdate: NoAction)

  @@index([publicacion_id], map: "idx_hist_publicacion")
}

model punto_encuentro {
  punto_encuentro_id BigInt        @id @default(autoincrement())
  nombre             String        @unique @db.VarChar(120)
  descripcion        String?
  lat                Decimal?      @db.Decimal(9, 6)
  lng                Decimal?      @db.Decimal(9, 6)
  activo             Boolean       @default(true)
  creado_en          DateTime      @default(now()) @db.Timestamptz(6)
  actualizado_en     DateTime      @default(now()) @db.Timestamptz(6)
  transaccion        transaccion[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model reporte {
  reporte_id                                    BigInt         @id @default(autoincrement())
  reportante_id                                 BigInt
  reportado_tipo                                String
  publicacion_id                                BigInt?
  usuario_reportado_id                          BigInt?
  motivo                                        motivo_reporte
  evidencia_url                                 String?
  descripcion                                   String?
  estado                                        estado_reporte @default(pendiente)
  creado_en                                     DateTime       @default(now()) @db.Timestamptz(6)
  actualizado_en                                DateTime       @default(now()) @db.Timestamptz(6)
  publicacion                                   publicacion?   @relation(fields: [publicacion_id], references: [publicacion_id], onDelete: Cascade, onUpdate: NoAction)
  usuario_reporte_reportante_idTousuario        usuario        @relation("reporte_reportante_idTousuario", fields: [reportante_id], references: [usuario_id], onUpdate: NoAction)
  usuario_reporte_usuario_reportado_idTousuario usuario?       @relation("reporte_usuario_reportado_idTousuario", fields: [usuario_reportado_id], references: [usuario_id], onDelete: Restrict, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model resena {
  resena_id      BigInt      @id @default(autoincrement())
  transaccion_id BigInt
  autor_id       BigInt
  calificacion   Int         @db.SmallInt
  comentario     String?
  creado_en      DateTime    @default(now()) @db.Timestamptz(6)
  usuario        usuario     @relation(fields: [autor_id], references: [usuario_id], onUpdate: NoAction)
  transaccion    transaccion @relation(fields: [transaccion_id], references: [transaccion_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([transaccion_id, autor_id], map: "uq_resena_unica_por_autor")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model transaccion {
  transaccion_id                            BigInt             @id @default(autoincrement())
  publicacion_id                            BigInt
  comprador_id                              BigInt
  vendedor_id                               BigInt
  punto_encuentro_id                        BigInt?
  fecha_hora                                DateTime?          @db.Timestamptz(6)
  estado                                    estado_transaccion @default(propuesta)
  motivo_cancelacion                        String?
  creado_en                                 DateTime           @default(now()) @db.Timestamptz(6)
  actualizado_en                            DateTime           @default(now()) @db.Timestamptz(6)
  resena                                    resena[]
  usuario_transaccion_comprador_idTousuario usuario            @relation("transaccion_comprador_idTousuario", fields: [comprador_id], references: [usuario_id], onUpdate: NoAction)
  publicacion                               publicacion        @relation(fields: [publicacion_id], references: [publicacion_id], onDelete: Cascade, onUpdate: NoAction)
  punto_encuentro                           punto_encuentro?   @relation(fields: [punto_encuentro_id], references: [punto_encuentro_id], onDelete: NoAction, onUpdate: NoAction)
  usuario_transaccion_vendedor_idTousuario  usuario            @relation("transaccion_vendedor_idTousuario", fields: [vendedor_id], references: [usuario_id], onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model usuario {
  usuario_id                                      BigInt                  @id @default(autoincrement())
  nombre                                          String                  @db.VarChar(100)
  carrera                                         String?                 @db.VarChar(100)
  semestre                                        Int?                    @db.SmallInt
  email                                           String                  @unique @db.VarChar(200)
  hash_password                                   String
  foto_url                                        String?
  rol                                             usuario_rol             @default(estudiante)
  is_activo                                       Boolean                 @default(true)
  ultimo_acceso                                   DateTime?               @db.Timestamptz(6)
  creado_en                                       DateTime                @default(now()) @db.Timestamptz(6)
  actualizado_en                                  DateTime                @default(now()) @db.Timestamptz(6)
  acceso_log                                      acceso_log[]
  conversacion_conversacion_usuario_a_idTousuario conversacion[]          @relation("conversacion_usuario_a_idTousuario")
  conversacion_conversacion_usuario_b_idTousuario conversacion[]          @relation("conversacion_usuario_b_idTousuario")
  mensaje                                         mensaje[]
  publicacion                                     publicacion[]
  publicacion_historial                           publicacion_historial[]
  reporte_reporte_reportante_idTousuario          reporte[]               @relation("reporte_reportante_idTousuario")
  reporte_reporte_usuario_reportado_idTousuario   reporte[]               @relation("reporte_usuario_reportado_idTousuario")
  resena                                          resena[]
  transaccion_transaccion_comprador_idTousuario   transaccion[]           @relation("transaccion_comprador_idTousuario")
  transaccion_transaccion_vendedor_idTousuario    transaccion[]           @relation("transaccion_vendedor_idTousuario")
}

enum estado_item {
  nuevo
  como_nuevo
  usado
  para_repuesto
}

enum estado_reporte {
  pendiente
  en_revision
  resuelto
  rechazado
}

enum estado_transaccion {
  propuesta
  acordada
  concretada
  cancelada
}

enum motivo_reporte {
  fraude
  lenguaje_inapropiado
  spam
  fuera_de_norma
  otro
}

enum usuario_rol {
  estudiante
  admin
}
